
import os
import json
from openai import OpenAI
import streamlit as st
from dotenv import load_dotenv


# .env íŒŒì¼ ë¡œë“œ
load_dotenv()

# --- API Key Setup ---
# í™˜ê²½ ë³€ìˆ˜ì— OPENAI_API_KEYê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì‚¬ìš©í•˜ê³ ,ì—†ë‹¤ë©´ streamlit ìƒì—ì„œ ì‚¬ìš©ìì—ê²Œ ì…ë ¥ë°›ëŠ”ë‹¤
open_api_key = os.getenv('OPENAI_API_KEY') or st.text_input(
    'Enter OpenAI API Key:',
    type='password',
    help='í™˜ê²½ ë³€ìˆ˜ OPENAI_API_KEYê°€ ì—†ë‹¤ë©´ ì—¬ê¸°ì„œ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.'
)
print(open_api_key)

if not open_api_key:
    st.warning("OpenAI API Keyë¥¼ ì…ë ¥í•˜ë©´ ì•±ì´ ë™ì‘í•©ë‹ˆë‹¤.")
    st.stop()

os.environ['OPENAI_API_KEY'] = open_api_key
client = OpenAI()

# --- Streamlit UI --- #streamlitì— ëŒ€í•œ ì§€ì‹ì´ ì—†ì–´ ê¸°ì¡´ì— colabì—ì„œ ì‘ì„±í•˜ì˜€ë˜ ì½”ë“œì— GPTì˜ ë„ì›€ì„ ë°›ì•„ ì‘ì„±í•˜ì˜€ë‹¤.

st.title("ë‹¤ì´ì–´íŠ¸ ë£¨í‹´ ì¶”ì²œ ë„ìš°ë¯¸ ğŸ’ª")
st.write("ì‚¬ìš©ì ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ë‹¤ì´ì–´íŠ¸ ë£¨í‹´ì„ ì¶”ì²œí•©ë‹ˆë‹¤.")

# ì…ë ¥ í¼ (ê°’ ì´ë¦„/êµ¬ì¡°ëŠ” ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼í•˜ê²Œ ìœ ì§€)
with st.form("health_form"):
    ë‚˜ì´ = st.number_input('ë‚˜ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 20):', min_value=0, max_value=120, value=20, step=1)
    í‚¤ = st.number_input('í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš” (cm, ì˜ˆ: 175.5):', min_value=0.0, max_value=250.0, value=175.5, step=0.1)
    ëª¸ë¬´ê²Œ = st.number_input('ëª¸ë¬´ê²Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (kg, ì˜ˆ: 70.2):', min_value=0.0, max_value=300.0, value=70.2, step=0.1)
    ì›í•˜ëŠ”ëª¸ë¬´ê²Œ = st.number_input('ëª©í‘œ ëª¸ë¬´ê²Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (kg, ì˜ˆ: 65.7):', min_value=0.0, max_value=300.0, value=65.7, step=0.1)
    ë‹¤ì´ì–´íŠ¸ê¸°ê°„ = st.number_input("ë‹¤ì´ì–´íŠ¸ ê¸°ê°„ (ì¼, ì˜ˆ: 14):", min_value=0, max_value=300, value=14, step=1)
    ë‹¤ì´ì–´íŠ¸ë°©ì‹ = st.selectbox('ì„ í˜¸í•˜ëŠ” ë‹¤ì´ì–´íŠ¸ ë°©ì‹', ['ìš´ë™', 'ì‹ë‹¨'])
    ì£¼ê°„ìš´ë™ë¹ˆë„ = st.number_input('ì›í•˜ëŠ” ì£¼ê°„ ìš´ë™ ë¹ˆë„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (íšŒ, ì˜ˆ: 3):', min_value=0, max_value=7, value=3, step=1)
    ê¸°íƒ€ì§ˆë³‘ = st.text_input("ê¸°íƒ€ ì§ˆë³‘ ì •ë³´ê°€ ìˆë‹¤ë©´ ì…ë ¥í•˜ì„¸ìš” (ì—†ìœ¼ë©´ 'ì—†ìŒ' ì…ë ¥):", value="ì—†ìŒ")

    submitted = st.form_submit_button("ë‹¤ì´ì–´íŠ¸ ë£¨í‹´ ì¶”ì²œ ë°›ê¸°")

# GPT API í˜¸ì¶œ í•¨ìˆ˜.
def get_answer(health_status):
    system_prompt = """
    íŠ¹ì • ë¬¸ì„œê°€ ì…ë ¥ë˜ì—ˆì„ ë•Œ ì…ë ¥ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¶”ì²œ ë‹¤ì´ì–´íŠ¸ ë£¨í‹´ì„ ì¶”ì²œí•©ë‹ˆë‹¤.
    1. ì‚¬ìš©ìì˜ ëª¸ë¬´ê²Œì™€ í‚¤ë¥¼ ê³ ë ¤í•©ë‹ˆë‹¤.
    2. ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ëª©í‘œ ëª¸ë¬´ê²Œë¥¼ ê³ ë ¤í•©ë‹ˆë‹¤.
    3. ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ë‹¤ì´ì–´íŠ¸ ê¸°ê°„ì„ ë³´ê³  ê¸°ê°„ì— ë§ëŠ” ë‹¤ì´ì–´íŠ¸ ë£¨í‹´ì„ ì¶”ì²œí•©ë‹ˆë‹¤.
    4. ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ìš´ë™ ë¹ˆë„ì™€ ë‹¤ì´ì–´íŠ¸ ë°©ì‹ì— ë§ëŠ” ë‹¤ì´ì–´íŠ¸ ë£¨í‹´ì„ ì¶”ì²œí•©ë‹ˆë‹¤.
    5. ì‚¬ìš©ìê°€ ê°€ì§€ê³  ìˆëŠ” ì§ˆë³‘ì— ì•…ì˜í–¥ì´ ì—†ëŠ” ë‹¤ì´ì–´íŠ¸ ë°©ì‹ì„ ê³ ë ¤í•©ë‹ˆë‹¤.
    6. ë‹¤ì´ì–´íŠ¸ ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ì€ ì–‘ì‹ì„ ë¬´ì¡°ê±´ ë”°ë¦…ë‹ˆë‹¤
    [1ì¼ì°¨~7ì¼ì°¨]
    ì•„ì¹¨ : [ì•„ì¹¨ì¶”ì²œ]
    ì ì‹¬ : [ì ì‹¬ì¶”ì²œ]
    ì €ë… : [ì €ë…ì¶”ì²œ]
    ìš´ë™ : [ìš´ë™ì¶”ì²œ]
    [8ì¼ì°¨~14ì¼ì°¨]
    ì•„ì¹¨ : [ì•„ì¹¨ì¶”ì²œ]
    ì ì‹¬ : [ì ì‹¬ì¶”ì²œ]
    ì €ë… : [ì €ë…ì¶”ì²œ]
    ìš´ë™ : [ìš´ë™ì¶”ì²œ]
    """

    user_content = "ì…ë ¥:" + str(health_status)
    response = client.chat.completions.create(
        model='gpt-4o-mini',  # ëª¨ë¸ ì´ë¦„ì´ ìœ íš¨í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content" : user_content}
        ]
    )
    return response.choices[0].message.content

if submitted:
    st.markdown("## --- ì…ë ¥ëœ ì‚¬ìš©ì ì •ë³´ ---")
    st.write(f"ë‚˜ì´: {ë‚˜ì´}ì„¸")
    st.write(f"í‚¤: {í‚¤}cm")
    st.write(f"ëª¸ë¬´ê²Œ: {ëª¸ë¬´ê²Œ}kg")
    st.write(f"ëª©í‘œ ëª¸ë¬´ê²Œ: {ì›í•˜ëŠ”ëª¸ë¬´ê²Œ}kg")
    st.write(f"ë‹¤ì´ì–´íŠ¸ ê¸°ê°„: {ë‹¤ì´ì–´íŠ¸ê¸°ê°„}")
    st.write(f"ì„ í˜¸í•˜ëŠ” ë‹¤ì´ì–´íŠ¸ ë°©ì‹: {ë‹¤ì´ì–´íŠ¸ë°©ì‹}")
    st.write(f"ì£¼ê°„ìš´ë™ë¹ˆë„: {ì£¼ê°„ìš´ë™ë¹ˆë„}")
    st.write(f"ê¸°íƒ€ ì§ˆë³‘: {ê¸°íƒ€ì§ˆë³‘}")

    #GPTì—ê²Œ ë³´ë‚¼ ì‚¬ìš©ì ê±´ê°• ìƒíƒœ ì •ë³´ ë”•ì…”ë„ˆë¦¬ë¥¼ ìƒì„±
    health_status = {
        "ë‚˜ì´": ë‚˜ì´,
        "í‚¤": í‚¤,
        "ëª¸ë¬´ê²Œ": ëª¸ë¬´ê²Œ,
        "ëª©í‘œ ëª¸ë¬´ê²Œ": ì›í•˜ëŠ”ëª¸ë¬´ê²Œ,
        "ë‹¤ì´ì–´íŠ¸ ê¸°ê°„": ë‹¤ì´ì–´íŠ¸ê¸°ê°„,
        "ì„ í˜¸í•˜ëŠ” ë‹¤ì´ì–´íŠ¸ ë°©ì‹": ë‹¤ì´ì–´íŠ¸ë°©ì‹,
        "ì£¼ê°„ìš´ë™ë¹ˆë„": ì£¼ê°„ìš´ë™ë¹ˆë„,
        "ê¸°íƒ€ì§ˆë³‘": ê¸°íƒ€ì§ˆë³‘
    }

    with st.spinner("AIê°€ ë‹¤ì´ì–´íŠ¸ ë£¨í‹´ì„  ì¶”ì²œ ì¤‘ì…ë‹ˆë‹¤..."):
        answer = get_answer(health_status)

    st.markdown("## --- ëª¨ë¸ ì›ë³¸ ì‘ë‹µ ---")
    st.code(answer, language="json")

